# ボディビルダー比較アプリケーション仕様書

## 1. アプリケーション概要
ボディビルダーの画像をコンテキスト（評価基準）に基づいて評価し、スコア化してランキング表示するWebアプリケーション

## 2. 主要機能
### 2.1 評価基準設定機能
- **評価コンテキスト**: テキストで評価基準を設定
- **基準例**: 「筋肉の定義」「プロポーション」「ポージング」など

### 2.2 画像アップロード機能
- **評価対象画像**: 1枚ずつアップロード（単体処理）
- **将来拡張**: 2枚以上の同時評価も対応予定
- **アップロード方法**: 
  - ドラッグ&ドロップ
  - ファイル選択ボタン
- **画像表示**:
  - サムネイル表示（小サイズ）
  - クリックで拡大表示

### 2.3 評価・判定機能
- **処理内容**: コンテキストに基づいて各画像を個別に評価
- **判定基準**: AIによる画像解析（dify APIを使用）
- **出力**: JSON形式のテキストデータとして評価結果を返却

### 2.4 結果蓄積・ランキング機能
- **評価結果蓄積**: 各画像の評価結果をセッション内で保持
- **ランキング生成**: 蓄積されたスコアをもとに自動ランキング作成
- **表示形式**: スコア付きランキング形式
- **表示内容**:
  - 順位
  - 画像サムネイル
  - スコア（数値）
  - AI分析コメント
- **保存**: なし（セッション内のみ）

## 3. 技術スタック
### 3.1 フロントエンド
- **フレームワーク**: Svelte v5
- **言語**: TypeScript
- **スタイリング**: GrabCSS（https://github.com/grabss/grabcss）

### 3.2 バックエンド
- **AI処理**: dify（クラウド版API）
  - 画像比較判定
  - スコア算出
- **実行環境**: Node.js

### 3.3 インフラ
- **開発環境**: Docker Compose
  - Svelteアプリケーションコンテナ
  - ※difyはクラウド版を使用（将来的にローカル化も可能）
- **本番環境**: 未定

### 3.4 データベース
- なし（セッション内でのみデータを保持）

## 4. ユーザーフロー
### 4.1 基本フロー（現在）
1. ユーザーが評価基準（コンテキスト）をテキストで入力
2. 評価対象画像を1枚アップロード
3. 「評価実行」ボタンをクリック
4. dify APIで画像を解析・スコア算出
5. JSON形式の評価結果を取得し、セッション内に蓄積
6. 必要に応じて次の画像をアップロードして評価を繰り返す（手順2-5）
7. 蓄積された複数の評価結果をスコア順にランキング表示

### 4.2 将来拡張フロー（複数枚同時評価）
1. ユーザーが評価基準（コンテキスト）をテキストで入力
2. 評価対象画像を複数枚同時アップロード
3. 「一括評価実行」ボタンをクリック
4. dify APIで各画像を順次または並列で解析・スコア算出
5. 全ての評価結果を取得し、自動的にランキング表示

## 5. エラー処理
### 5.1 バリデーション
- **画像以外のファイル**: フロントエンドでバリデーション、エラーメッセージ表示
- **評価コンテキスト未設定**: 評価実行ボタンを無効化
- **画像未選択**: 評価実行ボタンを無効化

### 5.2 API エラー
- **dify API エラー**: エラーメッセージと再試行ボタンを表示

## 6. 環境変数設定
```env
# API設定
VITE_DIFY_API_URL=https://api.dify.ai/v1  # 本番: クラウド版URL、開発: ローカルURL切替可能
VITE_DIFY_API_KEY=your_api_key_here

# アプリケーション設定
NODE_ENV=development
PORT=3015
```

## 7. 開発フェーズ
### Phase 1: 環境構築
- Docker Compose環境のセットアップ
- Svelte v5 + TypeScriptプロジェクト初期化

### Phase 2: API連携
- difyクラウド版アカウント作成
- API接続設定
- 通信テスト実装

### Phase 3: 簡易UI実装
- 評価コンテキスト入力機能
- 画像アップロード機能（単体）
- 基本的な評価実行機能
- シンプルな結果表示

### Phase 4: 本格UI実装
- デザイン改善
- UX最適化
- エラーハンドリング強化

## 8. ディレクトリ構造（予定）
```
judgment-app/
├── docker-compose.yml
├── Dockerfile
├── package.json
├── .env.example
├── src/
│   ├── routes/
│   │   └── +page.svelte
│   ├── lib/
│   │   ├── components/
│   │   │   ├── ImageUploader.svelte
│   │   │   ├── ResultDisplay.svelte
│   │   │   └── ImageModal.svelte
│   │   ├── api/
│   │   │   └── dify.ts
│   │   └── types/
│   │       └── index.ts
│   └── app.html
├── static/
└── vite.config.ts
```

## 9. API仕様（予定）
### 9.1 現在の単体評価API
#### dify API リクエスト
```typescript
interface EvaluationRequest {
  context: string;  // 評価基準（テキスト）
  image: string;  // Base64エンコード画像（単体）
}
```

#### dify API レスポンス
```typescript
interface EvaluationResponse {
  text: {
    score: number;  // 0-100
    analysis: string;  // AI分析コメント
    details?: {
      [key: string]: any;  // その他の詳細情報
    };
  };
}
```

### 9.2 将来の複数画像評価API（拡張予定）
#### リクエスト
```typescript
interface BatchEvaluationRequest {
  context: string;  // 評価基準（テキスト）
  images: string[];  // Base64エンコード画像配列
}
```

#### レスポンス
```typescript
interface BatchEvaluationResponse {
  text: {
    results: Array<{
      imageIndex: number;
      score: number;  // 0-100
      analysis: string;  // AI分析コメント
      details?: {
        [key: string]: any;
      };
    }>;
  };
}
```

## 10. 非機能要件
- **パフォーマンス**: 画像は圧縮してからAPI送信
- **セキュリティ**: APIキーは環境変数で管理
- **アクセシビリティ**: 基本的なキーボード操作対応
- **レスポンシブ**: モバイル・デスクトップ両対応

## 11. 制約事項
### 11.1 現在の制約
- 画像は一時的にメモリ上でのみ保持
- 評価結果の永続化なし（セッション内のみ）
- ユーザー認証なし
- 1回の評価で処理できるのは1枚の画像のみ
- 画像サイズ制限：TBD（dify API制限に依存）

### 11.2 将来の拡張計画
- 複数画像の同時評価機能
- 評価結果の永続化（データベース導入）
- より詳細な評価項目設定
- ユーザー毎の評価履歴管理